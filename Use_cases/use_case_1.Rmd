---
output: github_document
---

<!-- use_case_1.md is generated from use_case_1.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  fig.width = 8, fig.height = 4
)
options(tibble.print_min = 5, tibble.print_max = 5)
```

## Use case #1: time series of daily IWV differences (GNSS - ERA5)

```{r}
rm(list = ls())
library(purrr)
library(lubridate)
library(dplyr)
library(ggplot2)
library(PMLseg)

### paths to data and metadata
path_data = "./data/"
path_result = "./results/"
path_plots = "./plots/"
filename_metadata = "./metadata/metadata.txt"
station_name = "0alf"
# station_name = "clgo"
mylabely = "GNSS - ERA5 (kg/m2)"

### Segmentation options
criterion = "BM_BJ"
FunctPart = TRUE
VarMonthly = TRUE

### create output paths if they don't exist
if (!dir.exists(path_result)) {
  dir.create(path_result)
}
if (!dir.exists(path_plots)) {
  dir.create(path_plots)
}

### load metadata file
buffer = read.table(file = filename_metadata, header = TRUE) %>% 
  setNames(c("name", "year", "doy", "date", "type")) %>% 
  mutate(date = as.Date(date, format = "%Y-%m-%d"))
Metadata = buffer %>% select(all_of(c("name", "date", "type")))

### select metadata for the station
station_metadata = Metadata %>% filter(name ==  station_name)
print(sprintf("found %d metadata events for station %s", nrow(station_metadata), station_name))
print(station_metadata)

### load data for the station
path_data_one <- paste0(path_data, station_name, ".txt")
buffer <- read.table(
    file = path_data_one,
    sep = "\t",
    header = TRUE,
    na.strings = NaN,
    colClasses = c("character", "numeric"),
    col.names = c("date", "signal")
  )
buffer$date <- as.Date(buffer$date, format = "%Y-%m-%d")
OneSeries = buffer %>% select(all_of(c("date", "signal")))

### data info
n <- length(OneSeries$date)
np <- sum(!is.na(OneSeries$signal))
date_begin <- OneSeries$date[1]
date_end <- OneSeries$date[n]
days_diff <- as.numeric(difftime(date_end, date_begin, units = "days"))
completeness <- np / (days_diff + 1) * 100
print(sprintf("data summary: n=%d, np=%d, dates=%s..%s (%d days), completeness=%.2f%%", n, np, date_begin, date_end, days_diff, completeness))

### Run segmentation
seg = Segmentation(OneSeries = OneSeries, selectionK = criterion, selectionF = FALSE, Kmax = 30)
pp <- nrow(seg$Tmu)+length(seg$CoeffF)
print(seg$Tmu)
print(sqrt(seg$MonthVar))
print(sqrt(mean(seg$MonthVar)))
print(seg$SSR)

print(sprintf("Segmentation %s, %s: K=%d, min(mu)=%.2f, max(mu)=%.2f, rms(MonthVar)=%.2f, rss(CoeffF)=%.2f, sqrt(SSR/dof)=%.2f", station_name, criterion, length(seg$Tmu$begin), min(seg$Tmu$mean), max(seg$Tmu$mean), sqrt(mean(seg$MonthVar)), sqrt(sum(seg$CoeffF^2)), sqrt(seg$SSR/(np-pp))))

### plot series with segmentation results
mytitle <- sprintf("Station %s, %s", station_name, criterion)
p <- PlotSeg(OneSeries = OneSeries, SegRes = seg, FunctPart = TRUE, labelx = "", labely = mylabely, title = mytitle)
print(p)

### run validation
max_dist_validation = 62
valid = Validation(OneSeries = OneSeries, Tmu = seg$Tmu, Metadata = station_metadata, MaxDist = max_dist_validation)
print(sprintf("Validation %s, %s: CPs detected=%d, metadata=%d, validated=%d", station_name, criterion, nrow(seg$Tmu)-1, nrow(station_metadata), sum(valid$valid)))

### plot with validation results
p <- PlotSeg(OneSeries = OneSeries, SegRes = seg, FunctPart = TRUE, labelx = "", labely = mylabely, Metadata = station_metadata, Validated_CP_Meta = valid, title = mytitle)
print(p)

### cluster screening
screening <- Cluster_screening(Tmu = seg$Tmu, MaxDist = 80, alpha = 0.05, detail = TRUE)
print(screening)

### if some CPs have been removed
if (screening$ChangeCP == "Yes"){
    print(sprintf("Screening %s, %s: removed %d segment(s)", station_name, criterion, nrow(screening$RemoveData)))
    
    ### add tbegin and tend to RemoveData
    screening$RemoveData = screening$RemoveData %>% mutate(tbegin = OneSeries$date[screening$RemoveData$begin], tend = OneSeries$date[screening$RemoveData$end])

    ### update the time series
    OneSeries_updated <- UpdateTimeSeries(OneSeries, screening$RemoveData)

    ### update the segmentation parameters after screening
    seg_updated <- UpdatedParametersForFixedCP(OneSeriesUpd = OneSeries_updated, UpdatedCP = screening$UpdatedCP, FunctPart = TRUE)
    
    ### validate again
    validUpd = Validation(OneSeries = OneSeries_updated, Tmu = seg_updated$Tmu, Metadata = station_metadata, MaxDist = max_dist_validation)

    ### plot with validation results
    mytitle <- sprintf("Station %s, %s, after screening", station_name, criterion)
    p <- PlotSeg(OneSeries = OneSeries_updated, SegRes = seg_updated, FunctPart = TRUE, labelx = NULL, labely = mylabely, Metadata = station_metadata, Validated_CP_Meta = validUpd, title = mytitle)
    print(p)
    
} else {
    print(sprintf("Screening %s, %s: nothing removed", station_name, criterion))
    OneSeries_updated <- OneSeries
    seg_updated <- seg
}

### save plot
file_name = file.path(path_plots, paste0(station_name, ".png"))
ggplot2::ggsave(file_name, plot = p, width = 8, height = 4, units = "in")
```